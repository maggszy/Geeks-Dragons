---
title: "Raport „Geeks & Dragons”"
author: 'Urszula Spik, Natalia Jelito, Maciej Karczewski, Magdalena Szymkowiak'
date: '`r format(Sys.Date(), "%d.%m.%Y")`'
output: 
  pdf_document:
    number_sections: true
---

\renewcommand{\figurename}{Wykres}
\renewcommand{\tablename}{Tabela}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, fig.pos="H",out.width = "75%", fig.align = 'center')
options(scipen=999)

list.of.packages <- c("RMariaDB","ggplot2", "dplyr", "dbplyr", "tidyr", "kableExtra", "emojifont", "stringr", "colorspace", "wesanderson")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

library(RMariaDB)
library(ggplot2)
library(dplyr)
library(dbplyr) 
library(tidyr)
library(kableExtra)
library(emojifont)
library(stringr)
library(colorspace)
library(wesanderson)
```

```{r, echo=F, include=F}
pal <-wes_palette("GrandBudapest1", n=4, type="discrete")  #paleta kolorów
pal_con <- wes_palette("GrandBudapest1", n=10, type="continuous")

color1<-pal[1]
color2<- pal[2]
color3<-pal[3]
color4<- pal[4]

con <- dbConnect(RMariaDB::MariaDB(),
                dbname = 'team02',
                username = 'team02',
                password = "te@m0z",
                host = "giniewicz.it")
```

# Ranking na pracownika miesiąca

Ranking na pracownika miesiąca polega na wyłonieniu pracownika, który w danym miesiącu sumarycznie sprzedał i wynajął największą liczbę gier.

W przypadku remisu czynnikiem roztrzygającym, kto zostaje pracownikiem miesiąca jest liczba sprzedanych gier.

```{r, echo = F}
rental_info <- 'SELECT employee_id, COUNT(*) AS num_rented, CONCAT(first_name, " ", last_name) AS employee, MONTH(rental_date) as month, YEAR(rental_date) as year, DATE_FORMAT(rental_date,"%m-%Y") AS month_date
FROM Employees
INNER JOIN Rentals USING (employee_id)
GROUP BY month_date, employee_id'

sales_info <- 'SELECT employee_id, COUNT(*) AS num_sold, CONCAT(first_name, " ", last_name) AS employee, MONTH(date) as month, YEAR(date) as year,  DATE_FORMAT(date, "%m-%Y") AS month_date
FROM Employees
INNER JOIN Sales USING (employee_id)
INNER JOIN Finances USING(payment_id)
GROUP BY month_date, employee_id'

rental_df <- dbGetQuery(con, rental_info)
sales_df <- dbGetQuery(con, sales_info)
```


```{r, echo = F}
best_employee <-  rental_df %>% full_join(sales_df, by = c("employee_id", "month_date", "year", "month", "employee"))

best_employee[is.na(best_employee)] <- 0

best_employee <- best_employee %>%
  mutate(total_num = num_rented+num_sold) %>%
  mutate(employee=str_to_title(employee)) %>%
  arrange(employee)%>%
  group_by(month_date) %>%
  arrange(desc(total_num), .by_group=TRUE)%>%
  mutate(place = rank(-total_num, ties.method="min")) %>%
  arrange(desc(year), desc(month))

same_place <- best_employee %>%
  group_by(month_date, place) %>%
  mutate(place_sales = rank(-num_sold, ties.method="min"))%>%
  select(employee_id,month_date, place_sales, place)

best_employee <- best_employee %>% left_join(same_place, by=c("employee_id","month_date", "place"))%>% mutate(place_end=place+place_sales-1)
```

```{r, echo=F}
best_three <- best_employee %>% filter(place_end %in% c(1,2,3)) %>% select(month_date, employee, place_end)%>% pivot_wider(names_from = place_end, values_from = employee,values_fn = list)

best_three <- as.data.frame(best_three)
best_three[best_three=="NULL"] <- '-'

kable(best_three, col.names=c("Miesiąc", "Najlepszy pracownik (1. miejsce)", "2. miejsce", "3. miejsce"), caption="Top 3 pracowników w poszczególnych miesiącach.", align='cccc')%>%
  column_spec(2:4, width = "11em") %>% kable_styling(latex_options = c("HOLD_position")) %>%
  row_spec(0, bold=T, background=color1)
```

```{r,  fig.cap="Ilość sprzedanych i wypożyczonych gier przez trzech najlepszych pracowników w ostatnich 12 miesiącach."}
best_empl_res<-best_employee%>%arrange(year, month)%>%filter(place_end %in% c(1,2,3))%>%select(total_num, month_date, place_end)%>%distinct()%>%tail(12*3)

best_empl_res$month_date<-factor(best_empl_res$month_date,levels=unique(best_empl_res$month_date))

ggplot(best_empl_res, aes(x=month_date,y=as.integer(total_num), fill=as.factor(place_end))) + geom_col() +labs(x ="Miesiąc", y = "Ilość gier", fill="Miejsce") + scale_fill_manual(values=c(color1, color2, color3))+scale_x_discrete(guide = guide_axis(angle = 45))+
  geom_text(aes(label = as.integer(total_num)), size = 3,position = position_stack(vjust = 0.5), color="#E8E8E8")
```

```{r,echo=F}
month_now <- best_three$month_date[1]
best_empl_now <- best_three$`1`[1]
best_empl_now_res <- best_employee%>%filter(month_date==month_now & place_end==1)
```

Aktualnie pracownikiem miesiąca (`r month_now`) jest **`r best_empl_now`**. Tytuł ten otrzymuje dzięki sprzedaży `r as.integer(best_empl_now_res$num_sold[1])` gier i `r as.integer(best_empl_now_res$num_rented[1])` wypożyczeniom, co sumarycznie daje wynik **`r as.integer(best_empl_now_res$total_num[1])`** gier.

# Top 10 zawodników turniejowych

```{r, echo=F}
tournaments <- 'SELECT tournament_id,title, place, CONCAT(first_name, " ", last_name) AS customer_name FROM Tournaments_results INNER JOIN Customers USING(customer_id) INNER JOIN Tournaments USING(tournament_id) INNER JOIN Games USING(game_id)'

tournaments_df <- dbGetQuery(con, tournaments)
```

```{r, echo=F}
tournaments_num <- tournaments_df %>% select(title, tournament_id)%>%distinct()%>%group_by(title)  %>% summarise(num=n()) %>% arrange(desc(title))
```

Sklep przeprowadził turnieje w następujących grach: `r unique(tournaments_df$title)`. W sumie odbyło się **`r sum(tournaments_num$num)`** turniejów.

```{r, fig.cap="Liczba rozegranych turniejów w zależności od gry.", out.width = "65%"}
ggplot(tournaments_num, aes(factor(title, levels = title), num))+geom_col(fill=color1)+labs(x ="Tytuł gry", y = "Liczba turniejów")+coord_flip()
```

Ranking top graczy powstaje na podstawie punktów przyznawanych za miejsca w turnieju. Jeśli gracz wziął udział w większej liczbie turniejów z tej samej gry to punkty są sumowane. 

Punkty są przyznawane w sposób przedstawiony w tabeli \ref{tab_2}. Za pozostałe miejsca przyznawane jest 0 punktów.

```{r, echo=F, message=F}
points_rules <- c(100, 90, 80, 75, 70, 65, 60, 55, 50, 45, 40, 38, 36, 34, 32, 30, 28, 26, 24, 22, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1)

point_matrix<-as.data.frame(matrix(points_rules, 10, 4))
rownames(point_matrix) <- c(1,2,3,4,5,6,7,8,9,10)

kable(point_matrix, caption="\\label{tab_2} Punkty za poszczególne miejsca.", col.names=c("1-10", "11-20", "21-30", "31-40"), row.names=TRUE)%>%row_spec(0, bold = T,background=color1)%>%column_spec(1, bold = T,background=color1)%>%kable_styling(latex_options = c("HOLD_position"),position = "center")
```

```{r, echo=F, message=F}
best_players<-tournaments_df %>% group_by(tournament_id) %>% mutate(points=ifelse(is.na(points_rules[place]), 0, points_rules[place])) %>%
  group_by(title, customer_name) %>% mutate(suma=sum(points)) %>% ungroup() %>%
  select(title, customer_name, suma) %>% distinct() %>% group_by(title) %>% 
  arrange(desc(suma), .by_group = T) %>% top_n(10) %>% mutate(Miejsce=rank(-suma,ties.method="min"))
```

```{r, echo=F}
top_10_points <-best_players %>% select(Miejsce, title, suma) %>% distinct()%>%mutate(suma=as.character(suma))%>%
  pivot_wider(names_from=title, values_from=suma)%>% arrange(Miejsce)

top_10_points[is.na(top_10_points)] <- "-"

tournament_unique_num <- length(unique(tournaments_df$title))

kable(top_10_points, caption="Punkty top 10 graczy turniejowych z podziałem na gry.") %>%
  column_spec(2:(tournament_unique_num+1), width = "7em") %>% 
  kable_styling(latex_options = c("HOLD_position")) %>% 
  row_spec(0, bold=T, background=color1) %>% column_spec(1, bold = T,background=color1)
```

```{r, echo=F}
top_10 <-best_players %>% select(Miejsce, title, customer_name ) %>% 
  pivot_wider(names_from=title, values_from=customer_name,values_fn = list(customer_name = ~paste(., collapse = ", "))) %>% arrange(Miejsce)

top_10[is.na(top_10)] <- '-'

tournament_unique_num <- length(unique(tournaments_df$title))

kable(top_10, caption="Top 10 graczy turniejowych z podziałem na gry.") %>%
  column_spec(2:(tournament_unique_num+1), width = "7em") %>% 
  kable_styling(latex_options = c("HOLD_position")) %>% 
  row_spec(0, bold=T, background=color1) %>% column_spec(1, bold = T,background=color1)
```

# Rankingi popularności

W przypadku remisów gry uszeregowane są w kolejności alfabetycznej.

## Najczęściej wypożyczane gry

```{r, echo=F}
pop_rent <- 'SELECT Games.game_id, Games.title, Games.min_players, Games.max_players, Games.min_age, Games.price, COUNT(*) AS game_num
FROM Rentals
INNER JOIN Inventory USING(inventory_id)
INNER JOIN Games USING(game_id)
GROUP BY Games.game_id
ORDER BY game_num DESC, title;'

pop_rent_df <- dbGetQuery(con, pop_rent)
```

```{r, fig.cap="10 najczęściej wypożyczanych gier."}
ggplot(pop_rent_df %>% head(10) %>%  arrange(game_num, desc(title)), aes(x=factor(title, levels=title), y=as.integer(game_num))) + geom_col(fill=color1) + labs(x ="Tytuł gry", y = "Liczba wypożyczeń") + 
  coord_flip()
```

```{r, echo=FALSE}
rent_pop_max <- head(pop_rent_df,1)
rent_pop_max_df <- pop_rent_df %>% filter(game_num==rent_pop_max$game_num)
gamers_num <- unique(c(rent_pop_max$min_players, rent_pop_max$max_players))
```

Najczęściej wypożyczana gra to **`r rent_pop_max_df$title`**, została wypożyczona **`r as.integer(rent_pop_max$game_num)`** razy. Kosztuje `r rent_pop_max$price` zł, minimalny wiek graczy to `r rent_pop_max$min_age` lat, można w nią grać na `r paste(gamers_num, collapse='-' )` `r if_else(length(gamers_num)==1 && gamers_num[1]==1,"gracza","graczy")`.

## Najczęściej kupowane gry

```{r, echo=F}
pop_sales <- 'SELECT Games.game_id, Games.title, Games.min_players, Games.max_players, Games.min_age, Games.price, COUNT(*) AS game_num
FROM Sales
INNER JOIN Inventory USING(inventory_id)
INNER JOIN Games USING(game_id)
GROUP BY Games.game_id
ORDER BY game_num DESC, title;'

pop_sales_df <- dbGetQuery(con, pop_sales)
```

```{r, fig.cap = "10 najliczniej sprzedanych gier."}
ggplot(pop_sales_df %>% head(10) %>%arrange(game_num, desc(title)), aes(x=factor(title, levels=title), y=as.integer(game_num))) + geom_col(fill=color4) + labs(x ="Tytuł gry", y = "Liczba sprzedanych") +
  coord_flip()
```

```{r, echo=FALSE}
sale_pop_max <- head(pop_sales_df,1)
sale_pop_max_df <- pop_sales_df %>% filter(game_num==sale_pop_max$game_num)
gamers_num <- unique(c(sale_pop_max$min_players, sale_pop_max$max_players))
```

Najczęściej wypożyczana gra to **`r sale_pop_max_df$title`**, została wypożyczona **`r as.integer(sale_pop_max$game_num)`** razy. Kosztuje `r sale_pop_max$price` zł, minimalny wiek graczy to `r sale_pop_max$min_age` lat, można w nią grać na `r paste(gamers_num, collapse='-' )` `r if_else(length(gamers_num)==1 && gamers_num[1]==1,"gracza","graczy")`.

# Rankingi przetrzymywań

```{r, echo=F}
keep_games<-'SELECT Rentals.rental_id,Games.game_id, Customers.customer_id, CONCAT(Customers.first_name, " ", Customers.last_name) as customer_name, Games.title, Rentals.rental_date, Rentals.return_date, DATEDIFF(Rentals.return_date, Rentals.rental_date) AS day_num
FROM Rentals
INNER JOIN Inventory USING(inventory_id)
INNER JOIN Games USING(game_id)
INNER JOIN Customers USING(customer_id)
ORDER BY day_num DESC, rental_date DESC, Games.title'

keep_games_df <- dbGetQuery(con, keep_games)
```

## Aktualne wypożyczenia

```{r}
now_rented_games<-keep_games_df%>%filter(is.na(return_date))
old_recent <- now_rented_games%>%arrange(rental_date)%>%head(1)
new_recent <- now_rented_games%>%arrange(desc(rental_date))%>%head(1)
```

Aktualnie jest **`r now_rented_games%>%count()`** wypożyczonych gier. Najnowsze wypożyczenie pochodzi z `r format(new_recent$rental_date, "%d-%m-%Y")`. Najstarsze wypożyczenie pochodzi z `r format(old_recent$rental_date, "%d-%m-%Y")`.

## Najdłużejsze przetrzymywania

```{r, echo=F, fig.cap="Najdłużej przetrzymywane gry w historii sklepu."}
day_num_max <- head(keep_games_df,1)$day_num
rental_id_max <- keep_games_df %>% filter(day_num==day_num_max)
```

```{r, echo=F, fig.cap="Rozkład długości wypożyczeń w historii sklepu."}

ggplot(keep_games_df%>%filter(!is.na(return_date))%>%group_by(day_num)%>%summarise(n=n()), aes(x=factor(day_num, levels=day_num), y=n)) +
  geom_col(fill=color3)+
  theme(legend.position = "none") + labs(x ="Długość wypożyczenia", y = "Ilość wypożyczeń")
```
Gra najdłużej była przetrzymywana przez **`r day_num_max`** dni. Gry, które były przetrzymywane przez tyle dni zostały przedstawione w tabeli \ref{tab_5}.

```{r, echo=F}
keep_games_table<- keep_games_df %>% filter(day_num==day_num_max) %>% 
  select(title, customer_name, rental_date) %>% 
  mutate(rental_date=format(rental_date, "%d-%m-%Y"))

kable(keep_games_table, col.names=c("Tytuł gry","Klient","Data wypożyczenia"), caption="\\label{tab_5} Najdłużej przetrzymywane gry w historii sklepu wraz z datami wypożyczenia.", align='llcc')%>%kable_styling(latex_options = c("HOLD_position"),position = "center") %>% 
  row_spec(0, bold=T, background=color1)
```

## Średnia długość wypożyczenia w zależności od gry

Gry są średnio przetrzymywane **`r  round(mean(keep_games_df$day_num, na.rm=T),3)`** dni. Ochylenie standardowe wynosi **`r  round(sd(keep_games_df$day_num, na.rm=T),3)`** dni.

```{r echo=FALSE}
mean_keep_games <- keep_games_df %>% group_by(title) %>% summarise(mean_time=mean(day_num, na.rm=T)) %>% arrange(desc(mean_time), title)
```

```{r, echo=F, fig.cap="Średnie przetrzymywanie w zależności od gry."}
ggplot(mean_keep_games %>% head(10) %>% arrange(mean_time), aes(factor(title, levels=title), mean_time)) +
  geom_col(fill=color1) + labs(x ="Tytuł gry", y = "Średnia ilość dni") + coord_flip()
```

```{r, echo=F}
mean_max <- mean_keep_games%>%slice_max(mean_time)
```

Najdłuższy średni czas przetrzymywania to **`r round(mean_max$mean_time, 3)`** uzyskany przez grę **`r mean_max$title`**.

# Rankingi gier przynoszących największe zyski

```{r echo=F}
dochod_sales <- 'SELECT Games.game_id, Games.title, SUM(Finances.value) AS dochod, COUNT(*) AS game_num
FROM Sales
INNER JOIN Finances USING(payment_id)
INNER JOIN Inventory USING(inventory_id)
INNER JOIN Games USING(game_id)
GROUP BY Games.game_id
ORDER BY dochod DESC;'

dochod_rentals <- 'SELECT Games.game_id, Games.title, SUM(Finances.value) AS dochod, COUNT(*) AS game_num
FROM Rentals
INNER JOIN Finances USING(payment_id)
INNER JOIN Inventory USING(inventory_id)
INNER JOIN Games USING(game_id)
GROUP BY Games.game_id
ORDER BY dochod DESC;'

sales_df3 <- dbGetQuery(con, dochod_sales)
rentals_df3 <- dbGetQuery(con, dochod_rentals)
```

## 10 gier przynoszących największy dochód ze sprzedaży

Gry przychoszące największy dochód ze sprzedaży to tytuły gier, których sprzedana ilość razy ich cena dały największą kwotę pieniędzy.


```{r echo=F}
# 10 sprzadawanych gier przynoszącoych największy dochoód - liczba sprzedanych gier.
sales_df3_10 <- sales_df3 %>% select(-game_id) %>% slice_head(n=10)
# sales_df3_10$index <- seq_len(nrow(sales_df3_10)) %>% rev()

kable(sales_df3_10[,c(1,3)], col.names=c("Tytuł gry","Ilość"), caption="\\label{sales_top} Ilość sprzedanych gier, które przyniosły największy dochód z sprzdaży.", align='lc') %>% column_spec(1, width = "30em") %>% column_spec(2, width = "8em") %>%
  kable_styling(latex_options = c("HOLD_position"),position = "center") %>% row_spec(0, bold=T, background=color1)
```
W tabeli \ref{sales_top} znajdują się tytuły najbardziej dochodowych gier ze sprzedaży wraz z ilością sprzedanych egzemplarzy.

```{r fig.cap = "Gry przynoszące największy dochód ze sprzedaży."}
# sales_df3_10 <- sales_df3 %>% select(-game_id) %>% slice_head(n=10)
sales_df3_10 <- sales_df3_10 %>% arrange(desc(row_number()))

ggplot(sales_df3_10, aes(x=factor(title, levels=title),y=dochod)) + geom_col(fill=color1) + 
  labs(x ="Gra", y = "Dochód")  +
  coord_flip() 
```

Najbardziej dochodową grą, która była sprzadawana była gra **`r sales_df3_10$title[10]`**. Sprzedano **`r as.numeric(sales_df3_10$game_num[10])` ** egzemplarzy i dochód z niej wyniósł **`r sales_df3_10$dochod[10]` zł**.

## 10 gier przynoszących największy dochód z wypożyczeń

Koszt wypożyczenia gry wiąże się z liczbą dni wypożyczenia. Zatem gry przynoszące największy dochód to tytuły gier, które klienci sklepu najczęściej wypożyczali oraz najdłużej z nich użytkowali.


```{r fig.cap = " Gry przynoszące największy dochód z wypożyczeń."}
rentals_df3_10 <- rentals_df3 %>% select(-game_id) %>% slice_head(n=10)
rentals_df3_10 <- rentals_df3_10 %>% arrange(desc(row_number()))

ggplot(rentals_df3_10, aes(x=factor(title, levels=title),y=dochod)) + geom_col(fill=color4) +
  labs(x ="Gra", y = "Dochód", fill="Gra") + scale_fill_discrete(name="") + 
   coord_flip()
```

Najbardziej dochodową grą z wypożyczeń była gra **`r rentals_df3_10$title[10]`**. Wypożyczono ją **`r as.numeric(rentals_df3_10$game_num[10])`** razy. Dochód z niej wyniósł **`r rentals_df3_10$dochod[10]` zł**.


# Przychody i dochody sklepu

Przychody sklepu „Geeks & Dragons” dzielą się na 3 typy: 

  - przychody ze sprzedaży gier,
  - przychody z wypożyczeń,
  - wpisowe za udział w turnieju.

Dochodami sklepu jest suma przychodów pomniejszona o wydatki, którymi są pensje wypłacane pracownikom.

## Ranking Przychodów w poszczególnych miesiącach

```{r}
sales_income <- 'SELECT DATE_FORMAT(date, "%m-%Y") as ym, EXTRACT(YEAR FROM Finances.date) AS year, EXTRACT(MONTH FROM Finances.date) AS month, SUM(Finances.value) AS dochod
FROM Sales
INNER JOIN Finances USING(payment_id)
INNER JOIN Inventory USING(inventory_id)
GROUP BY year, month;'

rentals_income <- 'SELECT DATE_FORMAT(date, "%m-%Y") as ym, EXTRACT(YEAR FROM Finances.date) AS year, EXTRACT(MONTH FROM Finances.date) AS month, SUM(Finances.value) AS dochod
FROM Rentals
INNER JOIN Finances USING(payment_id)
INNER JOIN Inventory USING(inventory_id)
GROUP BY year, month;'

fee_income <- 'SELECT tournament_id, COUNT(*) AS num_players
FROM Tournaments_results
GROUP BY tournament_id'

sales_income_df <- dbGetQuery(con, sales_income)
rentals_income_df <- dbGetQuery(con, rentals_income)
fee_income_df <- dbGetQuery(con, fee_income)
```

```{r}
income <- merge(sales_income_df, rentals_income_df, by='ym',all=T) %>% select(-year.y, -month.y)
colnames(income) <- c("ym","year","month","sale_income","rental_income")
income$fee <- fee_income_df$num_players*20
income$total <- income$sale_income + income$rental_income + income$fee

#do odczytania największych przychodów
sale_max <- income %>% select(ym, sale_income) %>% slice_max(sale_income)
rental_max <- income %>% select(ym, rental_income) %>% slice_max(rental_income)
total_max <- income %>% select(ym, total) %>% slice_max(total)

kable(income[,c(1,4:7)], col.names=c("Data","Sprzadaż","Wypożyczenia","Turnieje","Przychód"), caption="\\label{income} Przychody sklepu w rozbiciu na typ przychodu w poszczególnych miesiącach.", align='ccccc')  %>%
  column_spec(1:5, width = "7em") %>%
  kable_styling(latex_options = c("HOLD_position")) %>% row_spec(0, bold=T, background=color1)
```

W tabeli \ref{income} znajdują się kwoty przychodów z różnych typów, które uzyskano w każdym miesiącu ostatniego roku działalności sklepu. Największy przychód ze sprzedaży gier był **`r sale_max[1]`** i wyniósł **`r sale_max[2]` zł**. Największy przychód z wypożyczeń został uzyskany w **`r rental_max[1]`** i wyniósł **`r rental_max[2]` zł**. Natomiast największy całkowicie przychód został osiągnięty **`r total_max[1]`** i wyniósł **`r as.numeric(total_max[2]/1)` zł**.

```{r fig.cap = "Przychody w poszczególnych miesiącach z podziałem na typ przychodu."}
income_long <- income %>% select(-month, -year, -total) %>% mutate(across(sale_income:fee, as.integer)) %>%
  pivot_longer(!ym, names_to = "type", values_to="value")
income_long$ym <- factor(income_long$ym,levels=unique(income_long$ym))


ggplot(income_long, aes(x=ym,y=as.integer(value), fill=as.factor(type))) + geom_col() + 
  labs(x ="", y = "Przychód", fill="Typ przychodu") + 
  scale_fill_manual(values=c(color3, color4, color1), labels = c("Wpisowe na turniej", "Wypożyczenia", "Sprzadaż")) + scale_x_discrete(guide = guide_axis(angle = 45))
```

## Dochód sklepu w poszczególnych miesiącach

```{r}
in_out <- 'SELECT DATE_FORMAT(date, "%m-%Y") as ym, EXTRACT(YEAR FROM date) AS year, EXTRACT(MONTH FROM date) AS month, in_out, SUM(value) AS income
FROM Finances
GROUP BY year, month, in_out'

in_out_df <- dbGetQuery(con, in_out)
```


```{r}
month_in_out <- in_out_df %>% filter(in_out == 1) %>% select(ym,month,income)
colnames(month_in_out)[3] <- "ins"
month_in_out$outs <- (in_out_df %>% filter(in_out == 0) %>% select(income))$income
month_in_out$income <- month_in_out$ins - month_in_out$outs

income_max <- month_in_out %>% select(ym, income) %>% slice_max(income)
income_min <- month_in_out %>% select(ym, income) %>% slice_min(income)


kable(month_in_out[,c(1,3:5)], col.names=c("Data","Przychód","Wydatki","Dochód"), caption=" \\label{tab_6_2} Całkowity dochód sklepu w poszczególnych miesiącach.",  align='cccc')  %>% column_spec(1:4, width = "9em") %>% 
  kable_styling(latex_options = c("HOLD_position")) %>% row_spec(0, bold=T, background=color1)
```

W tabeli \ref{tab_6_2} znajdują się przychody i wydatki sklepu oraz całkowity uzyskany dochód w poszczególnych miesiącach. Największy dochód sklep uzyskał **`r income_max[1]`** i wyniósł on **`r income_max[2]` zł**. Najgorszym miesiącem działalności sklepu okazał się **`r income_min[1]`**. Był to miesiąc, w którym uzyskano najmniejszy dochód w wysokości **`r income_min[2]` zł**.

```{r fig.cap = "Całkowity dochód sklepu w poszczególnych miesiącach."}
ggplot(month_in_out, aes(x=ym,y=income, fill=income)) + geom_col() +labs(x ="", y = "Dochód", fill="") + 
  scale_colour_gradient2(low=color3, high=color4, aesthetics = "fill") + 
  scale_x_discrete(guide = guide_axis(angle = 45))
```


```{r}
dates <- in_out_df$ym %>% unique()
start_end <- c(min(dates), max(dates))

total_in <- in_out_df %>% filter(in_out == 1) %>% select(income) %>% sum()
total_out <- in_out_df %>% filter(in_out == 0) %>% select(income) %>% sum()
total_income <- total_in - total_out

mean_income <- total_income/ nrow(in_out_df %>% filter(in_out == 1) %>% select(income))
```

Całkowity dochód firmy od **`r start_end[1]`** do **`r start_end[2]`** wyniósł: **`r as.numeric(total_income)` zł**. Daje nam to średnio: **`r round(mean_income,2)` zł** dochodu na miesiąc.

